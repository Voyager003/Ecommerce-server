# Feature Specification: E-commerce Backend System

**Feature Branch**: `001-ecommerce-backend`
**Created**: 2026-01-06
**Status**: Draft

## User Scenarios & Testing

### User Story 1 - 회원 가입 및 인증 (Priority: P1)

고객이 이메일과 비밀번호로 회원 가입을 하고, 로그인하여 서비스를 이용할 수 있다.

**Why this priority**: 모든 주문/결제 기능의 전제 조건이며, 비회원 주문을 지원하지 않으므로 MVP 필수 기능

**Independent Test**: 회원 가입 후 로그인하여 토큰을 발급받고, 본인 정보를 조회할 수 있으면 성공

**Acceptance Scenarios**:

1. **Given** 신규 사용자, **When** 유효한 이메일/비밀번호/이름/휴대폰 번호로 가입 요청, **Then** 회원 등록 완료 및 신규 회원 쿠폰 자동 발급
2. **Given** 가입된 회원, **When** 올바른 이메일/비밀번호로 로그인, **Then** 액세스 토큰과 리프레시 토큰 발급
3. **Given** 5회 연속 로그인 실패한 계정, **When** 로그인 시도, **Then** 30분간 계정 잠금 및 에러 메시지 반환
4. **Given** 액세스 토큰 만료된 회원, **When** 리프레시 토큰으로 재발급 요청, **Then** 새로운 액세스 토큰 발급

---

### User Story 2 - 상품 조회 및 탐색 (Priority: P1)

고객이 판매 중인 상품을 검색하고, 카테고리별로 필터링하며, 상세 정보를 확인할 수 있다.

**Why this priority**: 주문의 전제 조건이며, 상품 없이는 구매 흐름이 불가능

**Independent Test**: 상품 목록 조회 후 특정 상품의 상세 정보(옵션, 재고 상태)를 확인할 수 있으면 성공

**Acceptance Scenarios**:

1. **Given** 판매 중인 상품이 있는 상태, **When** 상품 목록 조회 요청, **Then** 페이징된 상품 목록 반환 (기본 20개)
2. **Given** 여러 카테고리의 상품 존재, **When** 특정 카테고리로 필터링, **Then** 해당 카테고리 상품만 반환
3. **Given** 옵션이 있는 상품, **When** 상품 상세 조회, **Then** 옵션 목록, 옵션별 가격/재고, 리뷰 요약 정보 반환
4. **Given** INACTIVE 상태의 상품, **When** 고객이 상품 목록 조회, **Then** 해당 상품 미노출

---

### User Story 3 - 주문 및 결제 (Priority: P1)

고객이 상품을 선택하여 주문하고, 결제를 완료하여 구매를 확정할 수 있다.

**Why this priority**: E-commerce의 핵심 가치 전달 - 상품 구매 완료가 비즈니스의 본질

**Independent Test**: 상품 선택 → 주문 생성 → 결제 완료 → 주문 상태 PAID 확인 흐름이 성공하면 완료

**Acceptance Scenarios**:

1. **Given** 로그인한 회원, 재고 있는 상품, **When** 주문 생성 요청, **Then** 주문 생성 및 재고 예약, 주문번호(ORD-YYYYMMDD-NNNNNN) 반환
2. **Given** PENDING 상태 주문, **When** 결제 요청 (멱등키 포함), **Then** PG 승인 후 주문 상태 PAID로 변경
3. **Given** 동일 멱등키로 중복 결제 요청, **When** 결제 처리, **Then** 기존 결제 결과 반환 (중복 처리 방지)
4. **Given** 결제 실패, **When** PG 승인 거부, **Then** 주문 상태 CANCELLED, 예약 재고 복원
5. **Given** 주문 생성 후 30분 경과, 결제 미완료, **When** 시스템 자동 처리, **Then** 주문 자동 취소, 재고 복원

---

### User Story 4 - 재고 관리 (Priority: P2)

시스템이 상품 재고를 정확하게 관리하여 주문 시 재고 부족 문제를 방지하고, 동시 주문 시 데이터 정합성을 보장한다.

**Why this priority**: 결제 흐름이 작동하려면 재고 관리가 필수이나, MVP에서는 기본 로직만 필요

**Independent Test**: 동시에 100명이 재고 1개 상품을 주문했을 때 정확히 1명만 성공하면 완료

**Acceptance Scenarios**:

1. **Given** 가용 재고 10개, **When** 5개 주문 생성, **Then** 가용 재고 5개, 예약 재고 5개
2. **Given** 예약 재고 5개, 결제 완료, **When** 결제 확정, **Then** 예약 재고 5개 차감
3. **Given** 가용 재고 0개, **When** 주문 시도, **Then** 재고 부족 에러 반환
4. **Given** 동시에 100명이 재고 1개 상품 주문, **When** 모든 요청 처리, **Then** 정확히 1명 성공, 99명 재고 부족 에러
5. **Given** 주문 취소, **When** 취소 처리, **Then** 예약 재고 → 가용 재고 복원

---

### User Story 5 - 쿠폰 적용 (Priority: P2)

고객이 보유한 쿠폰을 주문 시 적용하여 할인 혜택을 받을 수 있다.

**Why this priority**: 마케팅 및 프로모션 기능으로 비즈니스 가치가 있으나, 기본 결제 흐름 이후 추가

**Independent Test**: 쿠폰 적용 후 할인된 금액으로 결제가 완료되면 성공

**Acceptance Scenarios**:

1. **Given** 5,000원 정액 할인 쿠폰 보유, 30,000원 주문, **When** 쿠폰 적용, **Then** 결제 금액 25,000원
2. **Given** 10% 정률 할인 쿠폰 (최대 10,000원), 200,000원 주문, **When** 쿠폰 적용, **Then** 할인 금액 10,000원 (상한 적용)
3. **Given** 최소 주문 금액 30,000원 조건 쿠폰, 20,000원 주문, **When** 쿠폰 적용 시도, **Then** 적용 불가 에러
4. **Given** 유효기간 만료 쿠폰, **When** 적용 시도, **Then** 적용 불가 에러
5. **Given** 주문 취소, 유효기간 내 쿠폰 사용됨, **When** 취소 처리, **Then** 쿠폰 복원

---

### User Story 6 - 회원 등급 및 혜택 (Priority: P3)

회원의 구매 금액에 따라 등급이 산정되고, 등급별 혜택(적립, 무료배송, 전용쿠폰)을 제공받는다.

**Why this priority**: 고객 충성도 기능으로 중요하나, 기본 구매 흐름 완성 후 확장

**Independent Test**: 등급 조건 충족 시 해당 등급 혜택(적립률, 무료배송)이 적용되면 성공

**Acceptance Scenarios**:

1. **Given** 최근 3개월 구매 금액 기준 GOLD 조건 충족, **When** 매월 1일 등급 재산정, **Then** 회원 등급 GOLD로 변경
2. **Given** GOLD 등급 회원, **When** 주문 시, **Then** 3% 적립, 배송비 무료
3. **Given** PLATINUM 등급 회원, **When** 등급 승급 시, **Then** 전용 쿠폰 자동 발급
4. **Given** SILVER 등급 회원, 50,000원 미만 주문, **When** 배송비 계산, **Then** 배송비 3,000원 부과

---

### Edge Cases

- 동일 이메일로 중복 가입 시도 시 명확한 에러 메시지 반환
- 탈퇴 후 30일 이내 동일 이메일로 재가입 시도 시 차단
- 옵션이 있는 상품을 옵션 선택 없이 주문 시도 시 에러
- 부분 취소 요청 시 지원하지 않음을 안내하는 에러
- 결제 타임아웃 시 UNKNOWN 상태로 처리 후 별도 동기화
- 쿠폰 할인 금액이 주문 금액을 초과하는 경우 주문 금액까지만 할인
- 선착순 쿠폰 1000명 동시 다운로드 시 정확한 수량만큼만 발급

---

## Requirements

### Functional Requirements - 회원 (Member)

- **FR-M001**: 시스템은 이메일, 비밀번호, 이름, 휴대폰 번호로 회원 가입을 지원해야 한다
- **FR-M002**: 이메일은 시스템 전체에서 유일해야 한다
- **FR-M003**: 비밀번호는 최소 8자 이상, 영문/숫자/특수문자 각 1개 이상 포함해야 한다
- **FR-M004**: 가입 완료 시 신규 회원 쿠폰이 자동 발급되어야 한다
- **FR-M005**: 로그인 성공 시 액세스 토큰과 리프레시 토큰을 발급해야 한다
- **FR-M006**: 5회 연속 로그인 실패 시 30분간 계정을 잠금해야 한다
- **FR-M007**: 계정 잠금 시간은 반복 실패 시 점진적으로 증가해야 한다 (30분 → 1시간 → 24시간)
- **FR-M008**: 배송지는 최대 5개까지 등록 가능하며, 기본 배송지 지정이 가능해야 한다
- **FR-M009**: 회원 탈퇴는 진행 중인 주문이 없는 경우에만 가능해야 한다
- **FR-M010**: 탈퇴 회원 이메일은 30일간 재가입 불가해야 한다

### Functional Requirements - 상품 (Product)

- **FR-P001**: 상품 등록 시 상품명, 가격, 설명, 카테고리, 대표 이미지는 필수 입력이어야 한다
- **FR-P002**: 상품 가격은 0원 이상이어야 한다
- **FR-P003**: 하나의 상품은 하나의 카테고리에만 속해야 한다
- **FR-P004**: 상품 옵션별로 추가 가격과 재고가 별도 관리되어야 한다
- **FR-P005**: 옵션이 있는 상품은 옵션 선택 없이 구매 불가해야 한다
- **FR-P006**: 상품 상태는 DRAFT, ACTIVE, INACTIVE, DELETED 4가지여야 한다
- **FR-P007**: DRAFT → ACTIVE 전환은 필수 정보 입력 완료 시에만 가능해야 한다
- **FR-P008**: INACTIVE → ACTIVE 전환은 재고 1개 이상일 때만 가능해야 한다
- **FR-P009**: DELETED 상태 상품은 조회되지 않고 복구 불가해야 한다
- **FR-P010**: 상품 목록은 페이징 처리되어야 한다 (기본 20개)
- **FR-P011**: 카테고리별, 가격대별, 상품명 검색이 가능해야 한다
- **FR-P012**: 정렬 옵션은 최신순, 가격 낮은순, 가격 높은순, 판매량순을 지원해야 한다
- **FR-P013**: 카테고리는 2단계 계층 구조(대분류 → 소분류)를 가져야 한다

### Functional Requirements - 재고 (Inventory)

- **FR-I001**: 재고는 상품 옵션 단위로 관리되어야 한다
- **FR-I002**: 재고 수량은 0 이상의 정수여야 한다
- **FR-I003**: 재고는 가용 재고(available)와 예약 재고(reserved)로 구분되어야 한다
- **FR-I004**: 주문 생성 시 가용 재고에서 예약 재고로 이동해야 한다
- **FR-I005**: 결제 완료 시 예약 재고가 확정 차감되어야 한다
- **FR-I006**: 동시에 100명이 재고 1개 상품을 주문해도 1명만 성공해야 한다
- **FR-I007**: 재고 부족 시 명확한 에러 메시지와 함께 주문이 실패해야 한다
- **FR-I008**: 주문 취소 시 예약 재고가 가용 재고로 복원되어야 한다
- **FR-I009**: 동일 주문에 대해 중복 복원되지 않아야 한다
- **FR-I010**: 모든 재고 변동은 이력으로 기록되어야 한다

### Functional Requirements - 주문 (Order)

- **FR-O001**: 회원만 주문할 수 있어야 한다 (비회원 주문 불가)
- **FR-O002**: 여러 상품을 한 번에 주문할 수 있어야 한다
- **FR-O003**: 주문 번호는 날짜 + 시퀀스 형태로 생성되어야 한다 (예: ORD-20250106-000001)
- **FR-O004**: 동일 요청이 중복 전송되어도 주문은 한 번만 생성되어야 한다 (멱등성)
- **FR-O005**: 주문 상태는 PENDING, PAID, PREPARING, SHIPPED, DELIVERED, CANCELLED 6가지여야 한다
- **FR-O006**: 주문 금액 = 상품금액 합계 + 배송비 - 할인금액 이어야 한다
- **FR-O007**: 배송비는 기본 3,000원, 50,000원 이상 무료, GOLD/PLATINUM 회원 무료여야 한다
- **FR-O008**: 최종 결제 금액은 0원 이상이어야 한다
- **FR-O009**: PENDING 상태에서만 즉시 취소가 가능해야 한다
- **FR-O010**: PAID/PREPARING 상태 취소 시 환불 처리가 필요해야 한다
- **FR-O011**: 부분 취소는 지원하지 않아야 한다 (전체 취소만)
- **FR-O012**: 취소 시 사용한 쿠폰은 복원되어야 한다 (유효기간 내)
- **FR-O013**: 본인의 주문만 조회할 수 있어야 한다
- **FR-O014**: 주문 생성 후 30분 내 결제하지 않으면 자동 취소되어야 한다

### Functional Requirements - 결제 (Payment)

- **FR-Pay001**: 신용카드, 계좌이체, 가상계좌를 지원해야 한다
- **FR-Pay002**: 결제 요청 시 멱등키(Idempotency Key)가 필수여야 한다
- **FR-Pay003**: 동일 멱등키로 중복 요청 시 기존 결제 결과를 반환해야 한다
- **FR-Pay004**: 결제 요청 금액과 주문 금액이 일치해야 한다
- **FR-Pay005**: PENDING 상태의 주문만 결제 가능해야 한다
- **FR-Pay006**: 결제 상태는 PENDING, APPROVED, FAILED, UNKNOWN, REFUNDED 5가지여야 한다
- **FR-Pay007**: 결제 타임아웃 시 UNKNOWN 상태로 설정하고 이후 동기화해야 한다
- **FR-Pay008**: APPROVED 상태에서만 환불이 가능해야 한다
- **FR-Pay009**: 환불 요청도 멱등키 기반으로 중복 처리를 방지해야 한다
- **FR-Pay010**: 부분 환불은 지원하지 않아야 한다
- **FR-Pay011**: 모든 결제 시도는 이력으로 기록되어야 한다
- **FR-Pay012**: 결제 이력은 삭제되지 않아야 한다

### Functional Requirements - 쿠폰 (Coupon)

- **FR-C001**: 쿠폰 유형은 정액 할인, 정률 할인, 무료 배송 3가지여야 한다
- **FR-C002**: 정률 할인 쿠폰은 최대 할인 금액 한도를 가질 수 있어야 한다
- **FR-C003**: 쿠폰에는 최소 주문 금액 조건이 있을 수 있어야 한다
- **FR-C004**: 쿠폰에는 유효기간(시작일 ~ 종료일)이 있어야 한다
- **FR-C005**: 하나의 주문에 하나의 쿠폰만 적용 가능해야 한다
- **FR-C006**: 쿠폰 발급 수량 제한이 가능해야 한다 (선착순)
- **FR-C007**: 선착순 쿠폰은 동시에 1000명이 요청해도 정확히 수량만큼만 발급되어야 한다
- **FR-C008**: 회원 가입, 생일, 등급 승급 시 자동 발급이 가능해야 한다
- **FR-C009**: 사용 조건을 만족하지 않는 쿠폰은 적용 불가해야 한다
- **FR-C010**: 쿠폰 할인 금액이 주문 금액을 초과할 수 없어야 한다
- **FR-C011**: 주문 취소 시 유효기간 내 쿠폰은 복원되어야 한다

### Key Entities

- **Member**: 회원 정보 (이메일, 비밀번호, 이름, 휴대폰번호, 등급, 상태)
- **Address**: 배송지 정보 (회원과 1:N 관계, 최대 5개, 기본 배송지 여부)
- **Product**: 상품 정보 (이름, 가격, 설명, 카테고리, 상태, 대표이미지)
- **ProductOption**: 상품 옵션 (상품과 1:N 관계, 옵션명, 추가가격)
- **Category**: 카테고리 (대분류/소분류 2단계 계층, 이름)
- **Inventory**: 재고 (상품옵션과 1:1 관계, 가용수량, 예약수량)
- **InventoryHistory**: 재고 변동 이력 (변동유형, 수량, 사유, 관련주문)
- **Order**: 주문 정보 (주문번호, 회원, 상태, 금액정보, 배송지)
- **OrderItem**: 주문 항목 (주문과 1:N 관계, 상품, 옵션, 수량, 가격)
- **Payment**: 결제 정보 (주문과 1:1 관계, 결제수단, 상태, 금액, 멱등키)
- **PaymentHistory**: 결제 시도 이력 (요청시각, 응답시각, 응답코드)
- **Coupon**: 쿠폰 정책 (유형, 할인값, 조건, 유효기간, 발급수량)
- **MemberCoupon**: 회원 보유 쿠폰 (회원-쿠폰 관계, 발급일, 사용여부)

---

## Success Criteria

### Measurable Outcomes

- **SC-001**: 회원 가입부터 첫 구매 완료까지 5분 이내 가능
- **SC-002**: 상품 검색 결과가 1초 이내 반환
- **SC-003**: 결제 처리가 3초 이내 완료
- **SC-004**: 동시 주문 100건 발생 시 재고 정합성 100% 보장
- **SC-005**: 선착순 쿠폰 1000명 동시 요청 시 정확한 수량만 발급
- **SC-006**: 중복 결제 요청 시 이중 결제 발생률 0%
- **SC-007**: 시스템 장애 시에도 결제 데이터 유실 0%
- **SC-008**: 주문 자동 취소 30분 규칙 준수율 100%
- **SC-009**: 결제 후 취소 시 환불 + 재고 복원 완료율 100%

---

## Assumptions

- 회원 등급 기준 금액은 BRONZE(기본), SILVER(10만원 이상), GOLD(30만원 이상), PLATINUM(50만원 이상)으로 가정
- 신규 회원 쿠폰은 5,000원 정액 할인, 10,000원 이상 주문 시 사용 가능으로 가정
- 실제 PG 연동 대신 Mock PG를 사용하며, 성공/실패/타임아웃 시나리오를 시뮬레이션
- 이메일 인증, SMS 인증은 본 명세 범위 외 (추후 확장)
- 관리자 기능(상품 등록, 쿠폰 생성, 재고 입고 등)은 별도 명세로 분리
